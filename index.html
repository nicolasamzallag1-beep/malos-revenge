<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Malo's Revenge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.12);
      --hot:#FF3D7F;
      --hot2:#FFB000;
      --cyan:#46E3FF;
      --lime:#7CFF6B;
      --text:#EAF0FF;
      --muted: rgba(234,240,255,.72);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 24px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(70,227,255,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(255,61,127,.16), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      overflow:hidden;
      cursor:none;
    }

    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
      opacity:.35;
      pointer-events:none;
    }

    #game{
      position:relative;
      width:100vw;
      height:100vh;
      user-select:none;
    }

    /* Custom cursor */
    #cursor{
      position:fixed;
      left:0; top:0;
      width:64px; height:64px;
      transform:translate(-50%,-50%);
      pointer-events:none;
      z-index:99999;
      filter: drop-shadow(0 0 18px rgba(255,61,127,.65)) drop-shadow(0 0 26px rgba(70,227,255,.35));
    }
    #cursor .icon{
      width:64px; height:64px;
      display:grid;
      place-items:center;
      font-size:44px;
      transform: rotate(-12deg);
    }
    #cursor .ring{
      position:absolute; inset:0;
      border-radius:999px;
      border:2px solid rgba(234,240,255,.22);
      box-shadow: inset 0 0 0 2px rgba(255,61,127,.08);
      opacity:.9;
    }
    #cursor .dot{
      position:absolute;
      width:8px; height:8px;
      border-radius:999px;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      background: linear-gradient(135deg, var(--hot), var(--cyan));
      box-shadow: 0 0 18px rgba(255,61,127,.8);
    }

    /* HUD */
    .hud{
      position:fixed;
      left:18px; top:18px;
      display:flex;
      gap:12px;
      z-index:5000;
      align-items:stretch;
    }
    .brand{
      background: linear-gradient(135deg, rgba(255,61,127,.16), rgba(70,227,255,.10));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:14px 16px;
      box-shadow: var(--shadow2);
      min-width: 280px;
      backdrop-filter: blur(10px);
    }
    .brand .title{
      font-family: Orbitron, Inter, sans-serif;
      font-weight:900;
      letter-spacing: .08em;
      text-transform:uppercase;
      font-size: 16px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--muted);
    }
    .metrics{
      display:flex;
      gap:12px;
      margin-top:10px;
    }
    .metric{
      flex:1;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding:10px 12px;
    }
    .metric .k{
      font-size:11px;
      color: var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .metric .v{
      margin-top:6px;
      font-family: Orbitron, Inter, sans-serif;
      font-weight:900;
      font-size:22px;
      letter-spacing:.02em;
      color: #FFF;
      text-shadow: 0 0 18px rgba(255,61,127,.25);
    }

    .controls{
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width: 220px;
    }

    .btn{
      appearance:none;
      border:none;
      border-radius: 14px;
      padding:11px 12px;
      font-weight:800;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:#081018;
      cursor:pointer;
      background: linear-gradient(135deg, var(--hot), var(--hot2));
      box-shadow: 0 10px 25px rgba(255,61,127,.25);
      transition: transform .12s ease, filter .12s ease;
      font-family: Orbitron, Inter, sans-serif;
      font-size: 12px;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn.secondary{
      background: linear-gradient(135deg, rgba(70,227,255,.95), rgba(124,255,107,.95));
      box-shadow: 0 10px 25px rgba(70,227,255,.18);
    }
    .btn.ghost{
      background: rgba(0,0,0,.25);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:none;
    }

    .hint{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      padding: 6px 2px 0 2px;
    }
    .hint kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: var(--text);
    }

    /* Start / Modal */
    .overlay{
      position:fixed; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.72);
      z-index:9000;
      padding: 18px;
    }
    .panel{
      width: min(900px, 96vw);
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,61,127,.18), transparent 55%),
        radial-gradient(800px 600px at 80% 15%, rgba(70,227,255,.16), transparent 55%),
        rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .panel .top{
      padding: 22px 22px 18px 22px;
      display:flex;
      gap: 14px;
      align-items:flex-start;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .panel h1{
      font-family: Orbitron, Inter, sans-serif;
      font-size: clamp(32px, 5vw, 58px);
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      line-height: 1.05;
      margin-top: 4px;
      text-shadow: 0 0 28px rgba(255,61,127,.25);
    }
    .panel .sub{
      margin-top: 12px;
      color: var(--muted);
      font-size: 15px;
      line-height: 1.6;
      max-width: 58ch;
    }

    .panel .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      padding: 18px 22px 22px 22px;
    }
    @media (max-width: 820px){
      .panel .grid{ grid-template-columns: 1fr; }
      .controls{ min-width: unset; }
      body{ cursor:auto; }
    }

    .card{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      padding: 16px;
    }
    .card h3{
      font-family: Orbitron, Inter, sans-serif;
      font-weight: 900;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-size: 13px;
      color: rgba(234,240,255,.88);
      margin-bottom: 10px;
    }
    .rules{
      color: rgba(234,240,255,.80);
      font-size: 14px;
      line-height: 1.65;
    }
    .rules ul{ margin-left: 18px; margin-top: 8px; }
    .rules li{ margin: 6px 0; }

    .diffs{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 520px){
      .diffs{ grid-template-columns: 1fr; }
    }
    .diff{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 14px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
    }
    .diff:hover{ transform: translateY(-2px); filter: brightness(1.05); border-color: rgba(255,255,255,.22); }
    .diff .t{
      font-family: Orbitron, Inter, sans-serif;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(234,240,255,.92);
      display:flex; gap:8px; align-items:center;
    }
    .diff .d{ margin-top: 8px; font-size: 12px; color: rgba(234,240,255,.72); line-height:1.5; }

    /* Faces preview on homepage */
    .faces{
      display:flex;
      gap:12px;
      margin-top:16px;
      flex-wrap:wrap;
    }
    .face{
      width:80px; height:80px;
      border-radius:999px;
      border:3px solid rgba(255,255,255,.18);
      overflow:hidden;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      background: rgba(0,0,0,.25);
    }
    .face img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }

    /* Targets */
    .target{
      position:absolute;
      width: 120px; height: 120px;
      transform: translate(-50%, -50%);
      will-change: transform, left, top;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.55));
      cursor:pointer;
    }
    .target .frame{
      width:100%; height:100%;
      border-radius: 999px;
      padding: 4px;
      background: conic-gradient(from 180deg, rgba(255,61,127,1), rgba(70,227,255,1), rgba(255,176,0,1), rgba(255,61,127,1));
      animation: spin 2.2s linear infinite;
    }
    .target .inner{
      width:100%; height:100%;
      border-radius:999px;
      overflow:hidden;
      background: rgba(0,0,0,.35);
      border: 2px solid rgba(255,255,255,.18);
      position:relative;
    }
    .target img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      transform: scale(1.03);
      filter: saturate(1.05) contrast(1.05);
    }
    .target .name{
      position:absolute;
      left:50%; bottom:-30px;
      transform: translateX(-50%);
      font-family: Orbitron, Inter, sans-serif;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      color: rgba(234,240,255,.92);
      white-space:nowrap;
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
      backdrop-filter: blur(8px);
    }
    .target .hp{
      position:absolute;
      left:50%; top:-14px;
      transform: translateX(-50%);
      width: 82px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      overflow:hidden;
    }
    .target .hp > i{
      display:block;
      height:100%;
      width: 100%;
      background: linear-gradient(90deg, var(--lime), var(--hot2), var(--hot));
      border-radius: 999px;
      box-shadow: 0 0 18px rgba(124,255,107,.25);
    }

    @keyframes spin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    /* FX */
    .bottle{
      position:absolute;
      left:0; top:0;
      transform: translate(-50%,-50%);
      pointer-events:none;
      z-index: 6000;
      font-size: 34px;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.5));
      animation: bottle 560ms cubic-bezier(.2,.8,.2,1) forwards;
      will-change: transform, left, top;
    }
    @keyframes bottle{
      0%{ opacity:1; transform: translate(-50%,-50%) rotate(0deg) scale(.9); }
      100%{ opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) rotate(780deg) scale(1.15); }
    }

    .pop{
      position:absolute;
      left:0; top:0;
      transform: translate(-50%,-50%);
      pointer-events:none;
      z-index: 6500;
      animation: pop 1600ms ease-out forwards;
      text-align:center;
      width: 360px;
    }
    .pop .msg{
      display:inline-block;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 40px rgba(0,0,0,.50);
      font-family: Orbitron, Inter, sans-serif;
      font-weight: 900;
      letter-spacing:.06em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 0 0 14px rgba(255,61,127,.25);
      line-height: 1.3;
      font-size: 15px;
    }
    .pop .sub{
      display:block;
      margin-top: 8px;
      font-family: Inter, sans-serif;
      font-weight: 700;
      letter-spacing:.02em;
      text-transform:none;
      color: rgba(234,240,255,.88);
      font-size: 14px;
    }
    @keyframes pop{
      0%{ opacity:0; transform: translate(-50%,-50%) translateY(8px) scale(.92); }
      15%{ opacity:1; transform: translate(-50%,-50%) translateY(0px) scale(1); }
      85%{ opacity:1; transform: translate(-50%,-50%) translateY(-20px) scale(1); }
      100%{ opacity:0; transform: translate(-50%,-50%) translateY(-90px) scale(1.05); }
    }

    .finger{
      position:absolute;
      left:0; top:0;
      transform: translate(-50%,-50%);
      pointer-events:none;
      z-index: 7000;
      font-size: 84px;
      filter: drop-shadow(0 0 22px rgba(255,61,127,.55));
      animation: finger 650ms cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes finger{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.25) rotate(-20deg); }
      20%{ opacity:1; transform: translate(-50%,-50%) scale(1) rotate(8deg); }
      100%{ opacity:0; transform: translate(-50%,-50%) scale(1.25) rotate(22deg) translateY(-20px); }
    }

    /* Game over */
    .over{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.78);
      z-index: 9500;
      padding: 18px;
    }
    .over .panel{ width: min(720px, 96vw); }
    .scoreBig{
      font-family: Orbitron, Inter, sans-serif;
      font-weight: 900;
      letter-spacing:.08em;
      font-size: clamp(42px, 8vw, 86px);
      color: #fff;
      text-shadow: 0 0 28px rgba(255,176,0,.25);
      margin-top: 10px;
    }

    /* Toast */
    #toast{
      position:fixed;
      left:50%; bottom: 22px;
      transform: translateX(-50%);
      z-index: 8000;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.40);
      color: rgba(234,240,255,.92);
      backdrop-filter: blur(10px);
      font-weight: 800;
      letter-spacing: .02em;
      opacity:0;
      transition: opacity .2s ease, transform .2s ease;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      max-width: min(760px, 92vw);
      text-align:center;
    }
    #toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }

    .sr{
      position:absolute;
      width:1px; height:1px;
      padding:0; margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      border:0;
    }
  </style>
</head>
<body>
  <div id="cursor" aria-hidden="true">
    <div class="ring"></div>
    <div class="dot"></div>
    <div class="icon">üç∑</div>
  </div>

  <div class="hud" aria-hidden="false">
    <div class="brand">
      <div class="title">üé™ Malo's Revenge <span class="pill" id="pillLevel">‚Äî</span></div>
      <div class="metrics">
        <div class="metric"><div class="k">Score</div><div class="v" id="score">0</div></div>
        <div class="metric"><div class="k">Temps</div><div class="v"><span id="time">60</span>s</div></div>
        <div class="metric"><div class="k">Combo</div><div class="v" id="combo">x1</div></div>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="btnPause" onclick="togglePause()">‚è∏ Pause</button>
      <button class="btn secondary" onclick="restart()">üîÅ Restart</button>
      <button class="btn ghost" onclick="toggleSound()">üîä Son : <span id="soundState">ON</span></button>
      <div class="hint">Clique pour tirer. <kbd>Espace</kbd> pause. <kbd>M</kbd> mute.</div>
    </div>
  </div>

  <div id="game"></div>
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- START -->
  <div class="overlay" id="start">
    <div class="panel">
      <div class="top">
        <div>
          <h1>üé™ MALO'S REVENGE</h1>
          <div class="sub">
            Balance des bouteilles de vin sur les t√™tes qui se baladent. Plus tu touches, plus tu d√©clenches le <b>doigt d'honneur</b> et les bruitages.
          </div>
          <div class="faces">
            <div class="face"><img src="malo.jpg" alt="Malo" onerror="this.parentNode.style.display='none'" /></div>
            <div class="face"><img src="marie.jpg" alt="Marie" onerror="this.parentNode.style.display='none'" /></div>
            <div class="face"><img src="nico.jpg" alt="PtitNico" onerror="this.parentNode.style.display='none'" /></div>
            <div class="face"><img src="valentine.jpg" alt="Valentine" onerror="this.parentNode.style.display='none'" /></div>
          </div>
        </div>
      </div>
      <div class="grid">
        <div class="card">
          <h3>R√®gles</h3>
          <div class="rules">
            <ul>
              <li>Tu as <b>60 secondes</b> pour faire le meilleur score.</li>
              <li>Chaque cible a <b>3 PV</b>. Au dernier coup : <b>üí•</b> + bonus.</li>
              <li>Les r√©actions et punchlines d√©pendent de la personne.</li>
              <li>Encha√Æne les touches pour monter le <b>combo</b> (et le chaos).</li>
            </ul>
          </div>
          <div class="diffs">
            <div class="diff" onclick="startGame('easy')">
              <div class="t">üôÇ Facile</div>
              <div class="d">Grosses t√™tes, vitesse cool. Parfait pour chauffer.</div>
            </div>
            <div class="diff" onclick="startGame('medium')">
              <div class="t">üòà Moyen</div>
              <div class="d">Rapide, nerveux. Le vrai jeu.</div>
            </div>
            <div class="diff" onclick="startGame('hard')">
              <div class="t">üíÄ Difficile</div>
              <div class="d">Speedrun du d√©rapage. Bonne chance.</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Conseil</h3>
          <div class="rules">
            Clique <b>sur la t√™te</b>, pas sur le nom.
            Si tu n'entends rien, clique une fois (les navigateurs bloquent l'audio avant interaction).
            <br><br>
            <b>Astuce :</b> vise les rebonds pr√®s des bords, √ßa fait du carton.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- GAME OVER -->
  <div class="over" id="over" style="display:none;">
    <div class="panel">
      <div class="top">
        <div>
          <h1>GAME OVER</h1>
          <div class="sub" id="finalLine">‚Äî</div>
          <div class="scoreBig" id="finalScore">0</div>
        </div>
      </div>
      <div class="grid" style="grid-template-columns: 1fr;">
        <div class="card" style="display:flex; gap:10px; justify-content:flex-end;">
          <button class="btn secondary" onclick="restart()">üîÅ Rejouer</button>
          <button class="btn ghost" onclick="closeOver()">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============ CONFIG ============
    const FRIENDS = [
      { id: 'malo',      name: 'Malo',      img: 'malo.jpg' },
      { id: 'marie',     name: 'Marie',     img: 'marie.jpg' },
      { id: 'ptitnico',  name: 'PtitNico',  img: 'nico.jpg' },
      { id: 'valentine', name: 'Valentine', img: 'valentine.jpg' },
    ];

    const DIFF = {
      easy:   { label:'üôÇ Facile',   spawn: 1100, speed: 1.9, size: 134 },
      medium: { label:'üòà Moyen',    spawn: 820,  speed: 2.6, size: 116 },
      hard:   { label:'üíÄ Difficile',spawn: 640,  speed: 3.4, size: 102 },
    };

    // Punchlines personnalis√©es (corrig√©es, sans fautes)
    const LINES = {
      malo: [
        "C'est qui √ßa ?",
        "On t'a d√©j√† vu quelque part ?",
        "On va faire comme si rien ne s‚Äô√©tait pass√©.",
        "T'es perdu fr√©rot ?",
        "La vie est tellement injuste!",
      ],
      marie: [
        "Je vais te gifler !",
        "PAS d'accord.",
        "Oups... √ßa part en drame.",
        "T'as un probl√®me ?",
        "On va en reparler.",
      ],
      ptitnico: [
        "Rastafarai !",
        "On dirait un probl√®me.",
        "Mauvaise √©nergie ",
        "Merci d'avoir tent√©.",
        "Tu t'acharnes ?",
      ],
      valentine: [
        "Elle co√ªte cher !",
        "T'as vraiment cru que c'√©tait une bonne id√©e ?",
        "C'√©tait hors budget, d√©sol√©.",
        "Tout le monde n'a pas le niveau.",
        "Tu peux pas te le permettre.",
      ],
      generic: [
        "DANS TA FACE !",
        "BOUM !",
        "AIE !",
        "TROP FACILE. !",
        "C'EST TERMIN√â !",
      ]
    };

    const ENDINGS = [
      { min: 0,   max: 99,  text: "Tu tires comme un pied. Reprends un verre et recommence." },
      { min: 100, max: 249, text: "Pas mal. Mais l√† c'est encore soft." },
      { min: 250, max: 399, text: "Solide. On commence √† te craindre." },
      { min: 400, max: 649, text: "Tr√®s chaud. Le cirque ferme √† cause de toi." },
      { min: 650, max: 999999, text: "L√©gendaire. T'es officiellement le sommelier du chaos." },
    ];

    // ============ STATE ============
    const gameEl = document.getElementById('game');
    const startEl = document.getElementById('start');
    const overEl  = document.getElementById('over');
    const toastEl = document.getElementById('toast');

    const scoreEl = document.getElementById('score');
    const timeEl  = document.getElementById('time');
    const comboEl = document.getElementById('combo');
    const levelPill = document.getElementById('pillLevel');

    let running = false;
    let paused  = false;
    let soundOn = true;

    let diffKey = 'medium';
    let score = 0;
    let timeLeft = 60;

    let spawnTimer = null;
    let tickTimer = null;

    let targets = [];

    let combo = 1;
    let comboTimer = null;

    // Audio (WebAudio)
    let AC = null;
    function audio(){
      if (!soundOn) return null;
      if (!AC) AC = new (window.AudioContext || window.webkitAudioContext)();
      return AC;
    }
    function beep(type='hit'){
      const ctx = audio();
      if (!ctx) return;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);

      const t0 = ctx.currentTime;
      if (type === 'throw'){
        o.type = 'sine';
        o.frequency.setValueAtTime(520, t0);
        o.frequency.exponentialRampToValueAtTime(220, t0 + 0.08);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.18, t0 + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.12);
        o.start(t0);
        o.stop(t0 + 0.13);
        return;
      }
      if (type === 'hit'){
        o.type = 'square';
        o.frequency.setValueAtTime(180, t0);
        o.frequency.exponentialRampToValueAtTime(90, t0 + 0.12);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.28, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.16);
        o.start(t0);
        o.stop(t0 + 0.18);
        return;
      }
      if (type === 'finger'){
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(420, t0);
        o.frequency.exponentialRampToValueAtTime(680, t0 + 0.08);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.22, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.14);
        o.start(t0);
        o.stop(t0 + 0.15);
        return;
      }
      if (type === 'boom'){
        o.type = 'triangle';
        o.frequency.setValueAtTime(140, t0);
        o.frequency.exponentialRampToValueAtTime(55, t0 + 0.25);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.35, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.30);
        o.start(t0);
        o.stop(t0 + 0.32);
      }
    }

    // Cursor
    const cursor = document.getElementById('cursor');
    document.addEventListener('mousemove', (e)=>{
      cursor.style.left = e.clientX + 'px';
      cursor.style.top  = e.clientY + 'px';
    });

    // Keyboard
    document.addEventListener('keydown', (e)=>{
      if (e.code === 'Space'){
        e.preventDefault();
        if (running) togglePause();
      }
      if (e.key.toLowerCase() === 'm'){
        toggleSound();
      }
    });

    function toast(text){
      toastEl.textContent = text;
      toastEl.classList.add('show');
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.classList.remove('show'), 1200);
    }

    function rand(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

    function startGame(key){
      diffKey = key;
      levelPill.textContent = DIFF[diffKey].label;
      startEl.style.display = 'none';
      overEl.style.display = 'none';

      clearAll();
      score = 0;
      timeLeft = 60;
      combo = 1;
      paused = false;
      running = true;
      renderHUD();

      toast('Clique pour tirer. Fais du bruit.');

      tickTimer = setInterval(()=>{
        if (!running || paused) return;
        timeLeft--;
        renderHUD();
        if (timeLeft <= 0) endGame();
      }, 1000);

      spawnTimer = setInterval(()=>{
        if (!running || paused) return;
        spawnTarget();
      }, DIFF[diffKey].spawn);

      for (let i=0;i<2;i++) spawnTarget();
    }

    function renderHUD(){
      scoreEl.textContent = score;
      timeEl.textContent = timeLeft;
      comboEl.textContent = 'x' + combo;
    }

    function togglePause(){
      if (!running) return;
      paused = !paused;
      document.getElementById('btnPause').textContent = paused ? '‚ñ∂ Reprendre' : '‚è∏ Pause';
      toast(paused ? 'Pause. Respire.' : 'Reprise. Vise bien.');
    }

    function toggleSound(){
      soundOn = !soundOn;
      document.getElementById('soundState').textContent = soundOn ? 'ON' : 'OFF';
      toast(soundOn ? 'Son ON üîä' : 'Son OFF üîá');
    }

    function restart(){
      location.reload();
    }

    function closeOver(){
      overEl.style.display = 'none';
    }

    function endGame(){
      running = false;
      paused = false;
      clearInterval(spawnTimer);
      clearInterval(tickTimer);
      spawnTimer = null;
      tickTimer = null;

      targets.forEach(t=> t.el.remove());
      targets = [];

      const ending = ENDINGS.find(e => score >= e.min && score <= e.max) || ENDINGS[0];
      document.getElementById('finalScore').textContent = score;
      document.getElementById('finalLine').textContent = ending.text;
      overEl.style.display = 'flex';

      beep('boom');
    }

    function clearAll(){
      clearInterval(spawnTimer);
      clearInterval(tickTimer);
      spawnTimer = tickTimer = null;
      targets.forEach(t=> t.el.remove());
      targets = [];
    }

    // ========= Target system =========
    function spawnTarget(){
      const friend = rand(FRIENDS);
      const cfg = DIFF[diffKey];
      const el = document.createElement('div');
      el.className = 'target';
      el.style.width = cfg.size + 'px';
      el.style.height = cfg.size + 'px';

      const cx = window.innerWidth * (0.5 + (Math.random()-0.5)*0.18);
      const cy = window.innerHeight * (0.52 + (Math.random()-0.5)*0.22);

      const angle = Math.random() * Math.PI * 2;
      const vx = Math.cos(angle) * cfg.speed;
      const vy = Math.sin(angle) * cfg.speed;

      const hpMax = 3;

      el.innerHTML = `
        <div class="frame">
          <div class="inner">
            <div class="hp"><i style="width:100%"></i></div>
            <img src="${friend.img}" alt="${friend.name}" draggable="false" onerror="this.style.display='none'" />
          </div>
        </div>
        <div class="name">${friend.name}</div>
      `;

      el.style.left = cx + 'px';
      el.style.top  = cy + 'px';

      const targetObj = { el, friend, x: cx, y: cy, vx, vy, hp: hpMax, hpMax };
      targets.push(targetObj);
      gameEl.appendChild(el);

      el.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        hit(targetObj, ev.clientX, ev.clientY);
      });
    }

    // Global click => throw bottle (for vibe)
    gameEl.addEventListener('click', (ev)=>{
      if (!running || paused) return;
      throwBottle(ev.clientX, ev.clientY, ev.clientX + (Math.random()-0.5)*120, ev.clientY + 220);
    });

    function hit(t, mx, my){
      if (!running || paused) return;

      const rect = t.el.getBoundingClientRect();
      const tx = rect.left + rect.width/2;
      const ty = rect.top + rect.height/2;
      throwBottle(mx, ty, tx, ty);

      t.hp = Math.max(0, t.hp - 1);
      const hpPct = (t.hp / t.hpMax) * 100;
      const bar = t.el.querySelector('.hp > i');
      if (bar) bar.style.width = hpPct + '%';

      score += Math.round(10 * combo);
      if (t.hp === 0) score += Math.round(15 * combo);

      combo = Math.min(10, combo + 1);
      clearTimeout(comboTimer);
      comboTimer = setTimeout(()=>{ combo = 1; renderHUD(); }, 900);

      renderHUD();

      beep('hit');
      spawnFinger(tx, ty);
      beep('finger');

      const personLine = rand(LINES[t.friend.id] || []);
      const genericLine = rand(LINES.generic);
      const msg = t.hp === 0 ? `üí• ${genericLine}` : `üç∑ ${genericLine}`;
      const sub = personLine ? `"${personLine}"` : '';
      spawnPop(tx, ty, msg, sub);

      t.vx *= -1;
      t.vy *= -1;

      if (t.hp === 0){
        beep('boom');
        const el = t.el;
        el.style.transition = 'transform 180ms ease, opacity 180ms ease';
        el.style.transform += ' scale(0.82)';
        el.style.opacity = '0.0';
        setTimeout(()=>{
          el.remove();
          targets = targets.filter(x => x !== t);
        }, 170);
      }
    }

    function spawnPop(x,y, line, sub){
      const el = document.createElement('div');
      el.className = 'pop';
      el.style.left = x + 'px';
      el.style.top  = y + 'px';
      el.innerHTML = `<div class="msg">${escapeHtml(line)}${sub ? `<span class="sub">${escapeHtml(sub)}</span>` : ''}</div>`;
      gameEl.appendChild(el);
      setTimeout(()=>el.remove(), 1620);
    }

    function spawnFinger(x,y){
      const el = document.createElement('div');
      el.className = 'finger';
      el.style.left = x + 'px';
      el.style.top  = y + 'px';
      el.textContent = 'üñï';
      gameEl.appendChild(el);
      setTimeout(()=>el.remove(), 700);
    }

    function throwBottle(x0,y0,x1,y1){
      if (running && !paused) beep('throw');

      const b = document.createElement('div');
      b.className = 'bottle';
      b.style.left = x0 + 'px';
      b.style.top  = y0 + 'px';
      b.style.setProperty('--dx', (x1 - x0) + 'px');
      b.style.setProperty('--dy', (y1 - y0) + 'px');
      b.textContent = 'üç∑';
      gameEl.appendChild(b);
      setTimeout(()=>b.remove(), 600);
    }

    // Movement loop
    function step(){
      requestAnimationFrame(step);
      if (!running || paused) return;

      const w = window.innerWidth;
      const h = window.innerHeight;
      const pad = 70;

      for (const t of targets){
        const size = parseFloat(t.el.style.width) || 110;

        t.x += t.vx;
        t.y += t.vy;

        const minX = pad;
        const maxX = w - pad;
        const minY = pad;
        const maxY = h - pad;

        if (t.x < minX){ t.x = minX; t.vx *= -1; }
        if (t.x > maxX){ t.x = maxX; t.vx *= -1; }
        if (t.y < minY){ t.y = minY; t.vy *= -1; }
        if (t.y > maxY){ t.y = maxY; t.vy *= -1; }

        t.el.style.left = t.x + 'px';
        t.el.style.top  = t.y + 'px';
      }
    }
    requestAnimationFrame(step);

    function escapeHtml(s){
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    window.addEventListener('resize', ()=>{});

  </script>
</body>
</html>
